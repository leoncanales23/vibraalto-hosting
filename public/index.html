
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>VIBRAALTO • Altar Digital</title>
<link rel="stylesheet" href="/assets/css/styles.css">
</head>
<body class="altar">
  <div id="particulas-reactivas"></div>
  <main class="hero">
    <h1>VIBRAALTO.CL</h1>
    <p class="lead">No es una promo. Es un rito.</p>
    <nav class="menu">
      <a href="/verdades.html">Liberar verdad</a>
      <a href="/muro.html">Muro de verdades</a>
    </nav>
  </main>
  <!-- AGE GATE (overlay bloqueante) -->
  <style>
    .agegate-overlay{position:fixed;inset:0;background:rgba(0,0,0,.94);color:#fff;display:grid;place-items:center;z-index:9999}
    .agegate-card{width:min(520px,92vw);background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:18px 18px 14px;text-align:center;backdrop-filter:blur(6px)}
    .agegate-actions{display:flex;gap:10px;justify-content:center;margin-top:12px;flex-wrap:wrap}
    .btn{padding:.7rem 1.1rem;border-radius:10px;border:1px solid #fff33a;background:#fff33a;color:#000;font-weight:700;cursor:pointer}
    .btn.ghost{background:transparent;color:#fff;border-color:#fff33a}
    .agegate-note{opacity:.7;font-size:.8rem;margin-top:.6rem}
    .agegate-video{width:100%;border-radius:10px;border:1px solid rgba(255,255,255,.12);margin-top:10px;max-height:50vh}
  </style>
  <div id="agegate" class="agegate-overlay" aria-modal="true" role="dialog">
    <div class="agegate-card">
      <h3 style="margin:.2rem 0 6px">Verificación rápida (18+)</h3>
      <p style="opacity:.85;margin:0 0 6px">Activa la cámara o confirma manualmente si eres mayor de edad.</p>
      <video id="ag_video" class="agegate-video" autoplay muted playsinline></video>
      <div class="agegate-actions">
        <button id="ag_camera" class="btn">Usar cámara</button>
        <button id="ag_i_am_18" class="btn ghost">Soy mayor de 18</button>
      </div>
      <div id="ag_msg" class="agegate-note">Tus imágenes no se suben; el análisis ocurre en tu dispositivo.</div>
    </div>
  </div>

<!-- ExoLeón FAB (adjust the link if you change number/text) -->
<a href="https://wa.me/56971747072?text=Hola%20ExoLe%C3%B3n%2C%20vengo%20desde%20vibraalto.cl"
   target="_blank" rel="noreferrer"
   style="position:fixed;right:18px;bottom:18px;z-index:5000;background:#10b981;color:#fff;
          border-radius:999px;padding:.8rem 1rem;text-decoration:none;font-weight:700;">
  Hablar con ExoLeón
</a>

<!-- face-api.js (CDN). Modelos deben estar en /public/models -->
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<script>
(async function(){
  const $ov = document.getElementById('agegate');
  const $v  = document.getElementById('ag_video');
  const $cam= document.getElementById('ag_camera');
  const $ok = document.getElementById('ag_i_am_18');
  const $msg= document.getElementById('ag_msg');

  function pass(){ $ov.style.display='none'; try{ $v.srcObject && $v.srcObject.getTracks().forEach(t=>t.stop()); }catch(_){} }
  function fail(m){ $msg.textContent = m || 'No pudimos verificar. Intenta de nuevo o confirma manualmente.'; }

  // Confirmación manual (fallback legal/UX)
  $ok.addEventListener('click', pass);

  // Intento con cámara
  $cam.addEventListener('click', async ()=>{
    try{
      $msg.textContent = 'Cargando modelos...';
      await Promise.all([
        faceapi.nets.tinyFaceDetector.loadFromUri('/models'),
        faceapi.nets.faceLandmark68Net.loadFromUri('/models'),
        faceapi.nets.ageGenderNet.loadFromUri('/models'),
      ]);
      $msg.textContent = 'Solicitando acceso a la cámara...';
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:'user' }, audio:false });
      $v.srcObject = stream;
      await new Promise(r=> $v.onloadedmetadata = r);
      $msg.textContent = 'Mira al centro unos segundos...';

      // 1–3 intentos de estimación
      let ok = false;
      for (let i=0; i<3 && !ok; i++){
        const det = await faceapi
          .detectSingleFace($v, new faceapi.TinyFaceDetectorOptions({ scoreThreshold: .5 }))
          .withAgeAndGender();
        if(det && det.age && det.age >= 18) ok = true;
        await new Promise(r=>setTimeout(r, 800));
      }
      if(ok){ pass(); } else { fail('No pudimos estimar 18+. Usa el botón "Soy mayor de 18".'); }
    }catch(err){
      console.error(err);
      fail('No hay cámara o fue denegada. Usa "Soy mayor de 18".');
    }
  });

  // Si el navegador no tiene mediaDevices, muestra sólo el botón manual
  if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
    $cam.style.display='none';
    $msg.textContent = 'Tu navegador no soporta cámara. Usa "Soy mayor de 18".';
  }
})();
</script>
</body>
</html>
